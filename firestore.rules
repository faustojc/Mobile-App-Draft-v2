rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isDeviceMember(deviceId) {
      let deviceData = get(/databases/$(database)/documents/devices/$(deviceId)).data;
      return request.auth != null && (
        deviceData.owner_uid == request.auth.uid ||
        (deviceData.members != null && request.auth.uid in deviceData.members)
      );
    }

    // Global admin override
    match /{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == "UIA1lk0byYUGj3YH5JMYr0j1UNF3";
    }

    // Device documents
    match /devices/{deviceId} {
      // Any authenticated user can read device info (needed for sharing flow)
      allow read: if request.auth != null;

      // User must set themselves as owner AND member
      allow create: if request.auth != null &&
                    request.resource.data.owner_uid == request.auth.uid &&
                    request.resource.data.members.hasAll([request.auth.uid]);

      // Owner only: rename, add/remove members
      allow update, delete: if resource.data.owner_uid == request.auth.uid;

      // Sensor readings sub-collection
      match /readings/{readingId} {
        allow read: if isDeviceMember(deviceId);
        allow create: if request.auth != null && request.resource.data.keys().hasAll(['created_at']);
      }
    }

    // Device sharing requests
    match /requests/{requestId} {
      // Any authenticated user can create a request (must set their own UID)
      allow create: if request.auth != null && request.resource.data.requesterUid == request.auth.uid;

      // Only the device owner can read, update, or delete requests
      allow read, update, delete: if request.auth != null && resource.data.ownerUid == request.auth.uid;
    }
  }
}